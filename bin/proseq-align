#!/bin/bash
# Align PRO-seq to make bam and bedgraph files

if [ $# -lt 2 ]; then
	echo -e "Usage:\t proseq-align [options] -f <fastq> -r <reference genome>"
	echo -e "Options:"
	echo -e "\t-a\taligner (STAR/BOWTIE; default = STAR)"
	echo -e "\t-b\toutput filename base (default = proseq.out)"
	exit
fi

SCRIPTDIR="~/Work/labuser/sl2665/stoat/bin/"
PATHTOALIGNER="~/Work/bin/"
ALIGNER="STAR"
BASE="proseq.out"

if [ ! -d _proseq_tmp ]; then
	mkdir _proseq_tmp
	fi

while [[ $# -ge 1 ]]; do
	key="$1"
	case $key in
		-f)
		FASTQ="$2"
		shift
		;;
		-r)
		REF="$2"
		shift
		;;
		-a)
		ALIGNER="$2"
		shift
		;;
		-b)
		BASE="$2"
		shift
		;;
		--default)
		;;
		*)
		;;
	esac
	shift
done

# Cut out adapter sequences if any
FASTQNOEXT=${FASTQ%.*}
FASTQNPE=${FASTQNOEXT##*/}
cutadapt -a TGGAATTCTCGGGTGCCAAGG ${FASTQ} > _proseq_tmp/${FASTQNPE}.trim.fastq 

# Tagging UMI to the sequence ID
${SCRIPTDIR}umi-split-fastq _proseq_tmp/${FASTQNPE}.trim.fastq

# Alignemnt to the reference genome
if [ $ALIGNER = "STAR" ]; then
	${PATHTOALIGNER}star --genomeDir ~/Work/shared/ref/hg38 \
		--readFilesIn _proseq_tmp/${FASTQNPE}.trim.UMItag.fastq \
		--outFilterMultimapNmax 1 --runThreadN 8 \
		--outFileNamePrefix _proseq_tmp/ 
fi;

# Collapse same UMIs at the same mapped positions 
${SCRIPTDIR}umi-collapse _proseq_tmp/Aligned.out.sam
mv _proseq_tmp/Aligned.out.uniqueUMI.bam $BASE.bam

# Generate bedgraph files
bedtools genomecov -ibam $BASE.bam -bg -strand + -5 | \
	awk '{print $1"\t"$2"\t"$3"\t"-1*$4}' > $BASE.mn.bedgraph
bedtools genomecov -ibam $BASE.bam -bg -strand - -5 > $BASE.pl.bedgraph

